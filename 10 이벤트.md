이벤트
========     
# 시스템간 강결합의 문제    
구매를 취소하면 환불을 처리해야한다.      
이때 환불 기능을 실행하는 주체는 `주문 도메인` 엔티티가 될 수 있다.       
              
도메인 객체에서 환불 기능을 실행하려면           
환불 기능을 제공하는 도메인 서비스를 파라미터로 전달받고               
취소 도메인 기능에서 도메인 서비스를 실행한다.               

```java

```
구조에 따라서 응용 서비스에서 환불 기능을 실행할 수도 있다.  

```java

```
보통 결제 시스템은 외부에 존재하므로 RefundService는 외부의 환불 시스템 서비스를 호출하는데, 이때 2가지 문제가 발생한다.      

* **첫번째 문제:**   
  외부 서비스가 정상이 아닐 경우 트랜잭션 처리를 어떻게 해야 할지 애매하다는 것이다.(롤백 or 커밋)    
  외부의 환불 서비스를 실행하는 과정에서 익셉션이 발생하면     
  환불에 실패했으므로 주문 취소 트랜잭션을 롤백하는 것이 맞다.     
  그러나 주문은 취소 상태로 변경하고 환불만 나중에 시도하는 방식으로도 처리 가능하다.     
* **두번째 문제:** 
  성능에 관한 이야기로, 호나불을 처리하는 외부 시스템의 응답시간이 길어지면 그만큼 대기 시간이 발생한다.   
  환불 처리 기능이 30초가 걸리면 주문 취소 기능은 30초만큼 대기 시간이 증가한다.    
  즉, 외부 서비스 성능에 직접적인 영향을 받는 문제가 있다.   
  
```java
```

두 가지 문제 외에 도메인 객체에 서비스를 전달하면 추가로 설계상 문제가 나타날 수 있다.      
우선, 아래와 같이 주문 로직과 결제 로직이 섞이는 문제가 있다.       
    
```java
```

**Order 주문을 표현하는 도메인** 객체인데, **결제 도메인**의 환불 관련 로직이 뒤섞이게 된다.       
이는 곧, 환불 기능이 바뀌면 Order도 영향을 받게 된다는 것을 의미하기도 한다.        
주문 도메인 객체의 코드를 결제 도메인 때문에 변경할지도 모르는 상황을 좋아 보이지 않는다.      
        
도메인 객체에 서비스를 전달할 때 또다른 문제는 기능을 추가할 때 발생한다.                
민약 주문을 취소한 뒤에 환불뿐만 아니라 취소했다는 내용을 통지해야 한다면 어떻게 될까?         
환불 도메인 서비스와 동일하게 파라미터로 통지 서비스를 받도록 추가로 구현해야하고         
이로 인해 로직이 섞이는 문제가 더 커져 트랜잭션 처리가 복잡해진다.        
결과적으로 영향을 주는 서비스가 2개나 증가했다.    
   
```java

```

지금까지 언급한 문제가 발생하는 이유는 **주문 BOUNDED CONTEXT와 결제 BOUNDED CONTEXT 간의 `강결합` 때문이다.**          
주문이 결제와 강하게 결합되어 있어서 **주문 BOUNDED CONTEXT**가 **결제 BOUNDED CONTEXT**에 영향을 받게 되는 것이다.      

이런 강한 결합을 없앨 수 있는 방법이 있는데 그것은 바로 **이벤트를 사용하는 것이다.**    
특히 비동기 이벤트를 사용하면 두 시스템 간의 결합을 크게 낮출 수 있다.    
한번 익숙해지면 모든 연동을 이벤트와 비동기로 처리하고 싶을 정도로 매력적인 것이 이벤트다.    

# 이벤트 개요 
> 이벤트 : 과거에 벌어진 어떤 것   
   
이벤트는 사용자가 어떠한 동작을 취한 것을 의미하며      
`암호를 변경했음`, `주문을 취소했음`과 같은 것들이 이벤트가 발생했다라고 말한다.     

이벤트가 발생했다는 것은 **상태**가 변경됐다는 것을 의미한다.       
앞선 예시도 `암호가 변경`, `주문이  취소 상태로 변경`되었음을 의미하기 때문이다.        
  
이벤트는 발생하는 것에서 끝나지 않는다.        
이벤트가 발생하면 그 이벤트에 반응하여 원하는 동작을 수행하는 기능을 구현한다.         
아래와 같이 제이쿼리를 이용해서 이벤트가 발생한다면 `alter()` 을 수행하도록 할 수 있다.   
      
```javascript
$("#mybtn").click(function(evt) {
    alert("경고");
});
```

도메인 모델에서도 UI 컴포넌트와 유사하게 도메인의 상태 변경을 이벤트로 표현할 수 있다.        
보통 `~할 때`, `~가 발생하면`, `만약 ~하면`과 같은 요구사항은       
도메인의 상태 변경과 관련된 경우가 많고 이런 요구사항을 이벤트를 이용해서 구현할 수 있다.      
    
`주문을 취소할 때 이메일을 보낸다`라는 요구사항에서      
`주문을 취소할 때`는 주문이 취소 상태로 바뀌는 것을 의미하므로       
`주문 취소됨 이벤트`를 활용해서 구현할 수 있다.      

## 이벤트 관련 구성요소   

[#](#)  
   
도메인 모델에 이벤트를 도입하려면 4개의 구현 요소를 구현해야한다.   
   
도메인 모델에서 이벤트 주체는 엔티티, 벨류, 도메인 서비스와 같은 도메인 객체다.      
이를 도메인 객체는 도메인 로직을 실행해서 상태가 바뀌면 관련 이벤트를 발생한다.     















